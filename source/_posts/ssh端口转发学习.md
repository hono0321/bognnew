---
title: SSH端口转发
author: hono
date: 2017-3-25 23:04:35   
updated: 2017-3-25 23:04:45
tags: [SSH,端口转发]
---

最近学习了下SSH端口转发，记录下以备忘。
SSH常用来建立远程链接，这个远程链接不光可以用来登录远程主机，管理主机，也可以用来当做隧道传输数据。
隧道用来传输的数据一般都是上层应用的数据。这里涉及到两个链接，一个是应用数据链接，一个是SSH隧道链接。
链接就会有方向，从客户端向服务器发起。常听说的正向代理，反向代理，正向隧道，反向隧道，就是跟这两个链接有关。
正向代理(正向隧道)：应用数据链接和隧道链接方向一致。
反向代理(反向隧道)：上述两个方向相反。<!--more-->

SSH的隧道就是SSH的端口转发，SSH端口转发分为本地端口转发，远程端口转发，动态端口转发等。

## 本地端口转发
场景就不说了，参考链接里讲的非常详细，简单记录下命令的用法。

```bash
ssh -L [绑定端口]:[目标主机]:[目标端口] [sshserver]
```
数据流方向和隧道方向一致，-L参数指明端口绑定在ssh客户端，在应用配置中将应用服务端配置为SSH客户端的绑定端口，这样应用客户端发送应用服务端的流量会首先发送到SSH客户端的绑定端口，SSH隧道又将流量通过隧道发送至ssh服务端，并通过服务端转发到目标主机的目标端口。数据在SSH隧道中是经过加密和解密的。
看这个命令，可以知道隧道是从ssh客户端发起到sshserver的，-L表示本地端口绑定也就是端口是绑定在ssh客户端上的，最后‘目标主机’‘目标端口’是指应用数据到达隧道终点即sshserver将被转发到的目的。
有几个地方需要注意，首先应用服务的端口应该配置为本地主机的绑定端口，就是说在应用客户端上应该配置数据发送给ssh的绑定端口而不是应用服务端的端口。这样从应用客户端发送给应用服务端的数据就变成发送给ssh绑定端口了，ssh监听到绑定端口的数据后，就无脑的走隧道了，并在隧道终点将数据解密发送给目标主机的目标端口。


## 远程端口转发
隧道方向和数据流方向是相反的。
```bash
ssh -R [绑定端口]:[目标主机]:[目标端口] sshserver
```
跟上一条命令只有参数变了。-R表示的是绑定端口是绑在sshserver上的，但实际隧道终点数据的转发是在client端。隧道方向仍然是ssh客户端到sshserver，将端口绑定在server端，应用程序配置发往应用服务端的数据都发送到sshserver的绑定端口，后面的就一样了，sshserver监听绑定端口上的数据，将数据通过隧道无脑发送至client，在client端转发至目标主机的目标端口。

## 本地端口转发和远程端口转发的区别
通过一个自己遇到的例子来说下，VM和服务器之间是隔离的，本地PC和VM可以互通，本地PC和服务器可以互通。通过端口转发建立VM和服务器之间的数据连接。

### 通过本地端口转发实现
VM和PC之间建立隧道，从VM发起到PC的ssh连接，需要VM端有ssh客户端，PC端起ssh服务，绑定端口为VM上指定的某个未启用的端口，如无管理员权限则不能使用1~1024之间的特性端口。应用配置为访问VM本地的绑定端口。
ssh -L 绑定端口:目标主机:目标端口 本地PC
数据流方向：跟正常思维比较相似也比较好理解，VM端应用访问本地的绑定端口，数据通过隧道加密并转发至sshserver端也就是本地PC，本地PC将数据解密后发送至目标主机的目标端口，因为VM和PC之间互通，PC和服务器之间互通，所以PC作为中转，比较好理解。

### 通过远程端口转发实现
VM和PC之间建立隧道，从PC发起到VM的ssh连接，需要VM端起ssh服务，PC端有ssh客户端，绑定端口为VM上指定的某个未启用的端口，应用配置为访问VM本地的绑定端口。
ssh -R 绑定端口:目标主机:目标端口 本地PC
数据流方向：其实跟上面是一样的，因为隧道建立之后就不需要关心他了，而数据流方向是一样的。


## 动态端口转发
```bash
ssh -D [本地端口] sshserver
```
客户端监听本地指定的端口，将发送到指定端口的数据都发往sshserver。这个原理简单，就是把本地所有发送至指定端口的流量都转到sshserver，在server端转发。具体应用需要自己配置或程序配置。




